package handlers

import (
	"database/sql"
	"net/http"

	"github.com/gin-gonic/gin"

	"iot-sensor-service/models"
	"iot-sensor-service/repositories"
)

// SensorHandler handles sensor CRUD operations.
type SensorHandler struct {
	repo repositories.SensorRepository
}

// NewSensorHandler creates a new sensor handler with the given repository.
func NewSensorHandler(repo repositories.SensorRepository) *SensorHandler {
	return &SensorHandler{repo: repo}
}

// ListSensors returns all sensors.
func (h *SensorHandler) ListSensors(c *gin.Context) {
	sensors, err := h.repo.GetAll()
	if err != nil {
		c.JSON(http.StatusInternalServerError, models.ErrorResponse{
			Error: "Failed to retrieve sensors",
		})
		return
	}

	c.JSON(http.StatusOK, models.SensorList{
		Sensors: sensors,
		Count:   len(sensors),
	})
}

// GetSensor returns a single sensor by ID.
func (h *SensorHandler) GetSensor(c *gin.Context) {
	sensorID := c.Param("id")

	sensor, err := h.repo.GetByID(sensorID)
	if err != nil {
		c.JSON(http.StatusInternalServerError, models.ErrorResponse{
			Error: "Failed to retrieve sensor",
		})
		return
	}

	if sensor == nil {
		c.JSON(http.StatusNotFound, models.ErrorResponse{
			Error:  "Sensor not found",
			Detail: "No sensor with id '" + sensorID + "'",
		})
		return
	}

	c.JSON(http.StatusOK, sensor)
}

// CreateSensor creates a new sensor.
func (h *SensorHandler) CreateSensor(c *gin.Context) {
	var input models.SensorCreate
	if err := c.ShouldBindJSON(&input); err != nil {
		c.JSON(http.StatusBadRequest, models.ErrorResponse{
			Error:  "Invalid request body",
			Detail: err.Error(),
		})
		return
	}

	sensor, err := h.repo.Create(&input)
	if err != nil {
		c.JSON(http.StatusBadRequest, models.ErrorResponse{
			Error:  "Failed to create sensor",
			Detail: err.Error(),
		})
		return
	}

	c.JSON(http.StatusCreated, sensor)
}

// UpdateSensor updates an existing sensor.
func (h *SensorHandler) UpdateSensor(c *gin.Context) {
	sensorID := c.Param("id")

	var input models.SensorUpdate
	if err := c.ShouldBindJSON(&input); err != nil {
		c.JSON(http.StatusBadRequest, models.ErrorResponse{
			Error:  "Invalid request body",
			Detail: err.Error(),
		})
		return
	}

	sensor, err := h.repo.Update(sensorID, &input)
	if err != nil {
		c.JSON(http.StatusBadRequest, models.ErrorResponse{
			Error:  "Failed to update sensor",
			Detail: err.Error(),
		})
		return
	}

	if sensor == nil {
		c.JSON(http.StatusNotFound, models.ErrorResponse{
			Error:  "Sensor not found",
			Detail: "No sensor with id '" + sensorID + "'",
		})
		return
	}

	c.JSON(http.StatusOK, sensor)
}

// DeleteSensor removes a sensor.
func (h *SensorHandler) DeleteSensor(c *gin.Context) {
	sensorID := c.Param("id")

	err := h.repo.Delete(sensorID)
	if err != nil {
		if err == sql.ErrNoRows {
			c.JSON(http.StatusNotFound, models.ErrorResponse{
				Error:  "Sensor not found",
				Detail: "No sensor with id '" + sensorID + "'",
			})
			return
		}
		c.JSON(http.StatusInternalServerError, models.ErrorResponse{
			Error: "Failed to delete sensor",
		})
		return
	}

	c.Status(http.StatusNoContent)
}
